<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º ‚Äî Natafit</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .day-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
    }
    
    .time-slot {
      border: 1px solid var(--accent2);
      border-radius: var(--radius);
      padding: 12px;
      margin: 8px 0;
      background: var(--bg);
    }
    
    .time-slot.booked {
      border-color: var(--accent1);
      background: color-mix(in srgb, var(--accent1) 10%, var(--bg));
    }
    
    .client-info {
      font-size: 14px;
      color: var(--muted);
      margin-top: 8px;
    }
    
    .add-slot {
      background: none;
      border: 2px dashed var(--accent2);
      border-radius: var(--radius);
      padding: 12px;
      width: 100%;
      color: var(--text);
      cursor: pointer;
      margin-top: 12px;
    }
    
    .add-slot:hover {
      border-color: var(--accent1);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    .modal.visible {
      display: flex;
    }
    
    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      width: 100%;
      max-width: 400px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--accent2);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text);
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header class="container header">
    <a href="index.html" class="logo"><img src="assets/logo.svg" alt="Natafit logo"/></a>
    <button class="hamburger" id="hamburger" aria-label="–ú–µ–Ω—é">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav class="nav" id="nav">
      <div class="controls">
        <button id="theme-toggle" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
          <span class="theme-toggle-text">–¢—ë–º–Ω–∞—è</span>
        </button>
        <button id="logoutBtn" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
      </div>
    </nav>
  </header>

  <main class="container">
    <nav style="background:var(--card);padding:16px;border-radius:var(--radius);margin-bottom:24px;display:flex;gap:12px;flex-wrap:wrap">
      <a href="admin-schedule.html" style="padding:8px 16px;border-radius:var(--radius);text-decoration:none;color:white;border:2px solid var(--accent1);background:var(--accent1)">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
      <a href="admin-clients.html" style="padding:8px 16px;border-radius:var(--radius);text-decoration:none;color:var(--text);border:2px solid var(--accent2)">–ö–ª–∏–µ–Ω—Ç—ã</a>
    </nav>

    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
      <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</h1>
      <button class="btn btn-primary" id="addWeekBtn">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–µ–ª—é</button>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:24px 0">
      <div style="background:var(--card);padding:20px;border-radius:var(--radius);border-left:4px solid var(--accent1)">
        <div style="font-size:14px;color:var(--muted);margin-bottom:8px">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        <div style="font-size:32px;font-weight:bold;color:var(--accent1)" id="totalSlots">0</div>
      </div>
      <div style="background:var(--card);padding:20px;border-radius:var(--radius);border-left:4px solid var(--accent2)">
        <div style="font-size:14px;color:var(--muted);margin-bottom:8px">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
        <div style="font-size:32px;font-weight:bold;color:var(--accent2)" id="bookedSlots">0</div>
      </div>
      <div style="background:var(--card);padding:20px;border-radius:var(--radius);border-left:4px solid #10b981">
        <div style="font-size:14px;color:var(--muted);margin-bottom:8px">–°–≤–æ–±–æ–¥–Ω–æ</div>
        <div style="font-size:32px;font-weight:bold;color:#10b981" id="freeSlots">0</div>
      </div>
      <div style="background:var(--card);padding:20px;border-radius:var(--radius);border-left:4px solid #f59e0b;cursor:pointer" onclick="showNewBookings()">
        <div style="font-size:14px;color:var(--muted);margin-bottom:8px">üîî –ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏</div>
        <div style="font-size:32px;font-weight:bold;color:#f59e0b" id="newBookings">0</div>
      </div>
    </div>
    
    <div class="schedule-grid" id="scheduleGrid">
      <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç–∞ -->
  <div class="modal" id="slotModal">
    <div class="modal-content">
      <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è</h3>
      <form id="slotForm">
        <div class="form-group">
          <label for="slotTime">–í—Ä–µ–º—è</label>
          <input type="time" id="slotTime" required>
        </div>
        <div class="form-group">
          <label for="clientName">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</label>
          <select id="clientSelect" style="width:100%;padding:8px;border:1px solid var(--accent2);border-radius:var(--radius);background:var(--bg);color:var(--text);margin-bottom:8px">
            <option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ --</option>
          </select>
          <input type="text" id="clientName" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞">
        </div>
        <div class="form-group">
          <label for="clientPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" id="clientPhone">
        </div>
        <div class="form-group">
          <label for="notes">–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea id="notes" rows="3"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function checkAuth() {
      const user = sessionStorage.getItem('authUser');
      if (!user) {
        window.location.href = 'admin-login.html';
      }
    }

    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    let schedule = JSON.parse(localStorage.getItem('schedule')) || {
      weeks: []
    };

    function saveSchedule() {
      localStorage.setItem('schedule', JSON.stringify(schedule));
    }

    function addWeek() {
      const week = {
        id: Date.now(),
        days: [
          { name: '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', slots: [] },
          { name: '–°—Ä–µ–¥–∞', slots: [] },
          { name: '–ü—è—Ç–Ω–∏—Ü–∞', slots: [] }
        ]
      };
      schedule.weeks.unshift(week);
      saveSchedule();
      renderSchedule();
    }

    function addSlot(weekId, dayIndex) {
      currentWeekId = weekId;
      currentDayIndex = dayIndex;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
      const clients = JSON.parse(localStorage.getItem('clients')) || [];
      const clientSelect = document.getElementById('clientSelect');
      clientSelect.innerHTML = '<option value="">-- –í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ --</option>' +
        clients.map(c => `<option value="${c.id}" data-phone="${c.phone}">${c.name} (${c.phone})</option>`).join('');
      
      document.getElementById('slotModal').classList.add('visible');
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞
    document.getElementById('clientSelect').addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      if (selected.value) {
        const clients = JSON.parse(localStorage.getItem('clients')) || [];
        const client = clients.find(c => c.id === parseInt(selected.value));
        if (client) {
          document.getElementById('clientName').value = client.name;
          document.getElementById('clientPhone').value = client.phone;
        }
      }
    });

    function closeModal() {
      document.getElementById('slotModal').classList.remove('visible');
      document.getElementById('slotForm').reset();
    }

    let currentWeekId, currentDayIndex;

    document.getElementById('slotForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const slot = {
        time: document.getElementById('slotTime').value,
        clientName: document.getElementById('clientName').value,
        clientPhone: document.getElementById('clientPhone').value,
        notes: document.getElementById('notes').value,
        id: Date.now()
      };

      const weekIndex = schedule.weeks.findIndex(w => w.id === currentWeekId);
      schedule.weeks[weekIndex].days[currentDayIndex].slots.push(slot);
      schedule.weeks[weekIndex].days[currentDayIndex].slots.sort((a, b) => a.time.localeCompare(b.time));
      
      saveSchedule();
      renderSchedule();
      closeModal();
    });

    function deleteSlot(weekId, dayIndex, slotId) {
      const week = schedule.weeks.find(w => w.id === weekId);
      if (week) {
        week.days[dayIndex].slots = week.days[dayIndex].slots.filter(s => s.id !== slotId);
        saveSchedule();
        renderSchedule();
      }
    }

    function renderSchedule() {
      const grid = document.getElementById('scheduleGrid');
      grid.innerHTML = '';

      let totalCount = 0;
      let bookedCount = 0;

      schedule.weeks.forEach(week => {
        week.days.forEach((day, dayIndex) => {
          totalCount += day.slots.length;
          bookedCount += day.slots.filter(s => s.clientName).length;
          
          const dayCard = document.createElement('div');
          dayCard.className = 'day-card';
          
          dayCard.innerHTML = `
            <h3>${day.name}</h3>
            ${day.slots.map(slot => `
              <div class="time-slot ${slot.clientName ? 'booked' : ''}">
                <strong>${slot.time}</strong>
                ${slot.clientName ? `
                  <div class="client-info">
                    <div>${slot.clientName}</div>
                    <div>${slot.clientPhone}</div>
                    ${slot.notes ? `<div>${slot.notes}</div>` : ''}
                  </div>
                ` : ''}
                <button class="btn btn-secondary" style="margin-top:8px" 
                  onclick="deleteSlot(${week.id}, ${dayIndex}, ${slot.id})">
                  –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            `).join('')}
            <button class="add-slot" onclick="addSlot(${week.id}, ${dayIndex})">
              + –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è
            </button>
          `;
          
          grid.appendChild(dayCard);
        });
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      document.getElementById('totalSlots').textContent = totalCount;
      document.getElementById('bookedSlots').textContent = bookedCount;
      document.getElementById('freeSlots').textContent = totalCount - bookedCount;
      
      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å)
      const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
      let newBookingsCount = 0;
      schedule.weeks.forEach(week => {
        week.days.forEach(day => {
          day.slots.forEach(slot => {
            if (slot.bookedAt && new Date(slot.bookedAt) > oneHourAgo) {
              newBookingsCount++;
            }
          });
        });
      });
      document.getElementById('newBookings').textContent = newBookingsCount;
    }

    function showNewBookings() {
      const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
      let newBookings = [];
      
      schedule.weeks.forEach(week => {
        week.days.forEach((day, dayIndex) => {
          day.slots.forEach(slot => {
            if (slot.bookedAt && new Date(slot.bookedAt) > oneHourAgo) {
              newBookings.push({
                day: day.name,
                time: slot.time,
                client: slot.clientName,
                phone: slot.clientPhone,
                bookedAt: new Date(slot.bookedAt).toLocaleString('ru-RU')
              });
            }
          });
        });
      });

      if (newBookings.length === 0) {
        alert('–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å');
        return;
      }

      const message = '–ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏:\n\n' + newBookings.map(b => 
        `${b.day}, ${b.time}\nüë§ ${b.client}\nüìû ${b.phone}\nüïê ${b.bookedAt}\n`
      ).join('\n');
      
      alert(message);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('addWeekBtn').addEventListener('click', addWeek);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      sessionStorage.removeItem('authUser');
      window.location.href = 'admin-login.html';
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    checkAuth();
    renderSchedule();
  </script>
  <script src="js/theme.js"></script>
</body>
</html>