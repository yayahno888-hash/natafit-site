<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Управление расписанием — Natafit</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .day-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
    }
    
    .time-slot {
      border: 1px solid var(--accent2);
      border-radius: var(--radius);
      padding: 12px;
      margin: 8px 0;
      background: var(--bg);
    }
    
    .time-slot.booked {
      border-color: var(--accent1);
      background: color-mix(in srgb, var(--accent1) 10%, var(--bg));
    }
    
    .client-info {
      font-size: 14px;
      color: var(--muted);
      margin-top: 8px;
    }
    
    .add-slot {
      background: none;
      border: 2px dashed var(--accent2);
      border-radius: var(--radius);
      padding: 12px;
      width: 100%;
      color: var(--text);
      cursor: pointer;
      margin-top: 12px;
    }
    
    .add-slot:hover {
      border-color: var(--accent1);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    .modal.visible {
      display: flex;
    }
    
    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      width: 100%;
      max-width: 400px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--accent2);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text);
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header class="container header">
    <a href="index.html" class="logo"><img src="assets/logo.svg" alt="Natafit logo"/></a>
    <nav class="nav">
      <div class="controls">
        <button id="theme-toggle" class="theme-toggle" aria-label="Переключить тему">
          <span class="theme-toggle-text" data-translate="theme.dark">Тёмная</span>
        </button>
        <button id="logoutBtn" class="btn btn-secondary">Выйти</button>
      </div>
    </nav>
  </header>

  <main class="container">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h1>Управление расписанием</h1>
      <button class="btn btn-primary" id="addWeekBtn">Добавить неделю</button>
    </div>
    
    <div class="schedule-grid" id="scheduleGrid">
      <!-- Расписание будет добавлено через JavaScript -->
    </div>
  </main>

  <!-- Модальное окно для добавления/редактирования слота -->
  <div class="modal" id="slotModal">
    <div class="modal-content">
      <h3 id="modalTitle">Добавить время</h3>
      <form id="slotForm">
        <div class="form-group">
          <label for="slotTime">Время</label>
          <input type="time" id="slotTime" required>
        </div>
        <div class="form-group">
          <label for="clientName">Имя клиента</label>
          <input type="text" id="clientName">
        </div>
        <div class="form-group">
          <label for="clientPhone">Телефон</label>
          <input type="tel" id="clientPhone">
        </div>
        <div class="form-group">
          <label for="notes">Заметки</label>
          <textarea id="notes" rows="3"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Проверка авторизации
    function checkAuth() {
      const user = sessionStorage.getItem('authUser');
      if (!user) {
        window.location.href = 'admin-login.html';
      }
    }

    // Структура данных для хранения расписания
    let schedule = JSON.parse(localStorage.getItem('schedule')) || {
      weeks: []
    };

    function saveSchedule() {
      localStorage.setItem('schedule', JSON.stringify(schedule));
    }

    function addWeek() {
      const week = {
        id: Date.now(),
        days: [
          { name: 'Понедельник', slots: [] },
          { name: 'Среда', slots: [] },
          { name: 'Пятница', slots: [] }
        ]
      };
      schedule.weeks.unshift(week);
      saveSchedule();
      renderSchedule();
    }

    function addSlot(weekId, dayIndex) {
      currentWeekId = weekId;
      currentDayIndex = dayIndex;
      document.getElementById('slotModal').classList.add('visible');
    }

    function closeModal() {
      document.getElementById('slotModal').classList.remove('visible');
      document.getElementById('slotForm').reset();
    }

    let currentWeekId, currentDayIndex;

    document.getElementById('slotForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const slot = {
        time: document.getElementById('slotTime').value,
        clientName: document.getElementById('clientName').value,
        clientPhone: document.getElementById('clientPhone').value,
        notes: document.getElementById('notes').value,
        id: Date.now()
      };

      const weekIndex = schedule.weeks.findIndex(w => w.id === currentWeekId);
      schedule.weeks[weekIndex].days[currentDayIndex].slots.push(slot);
      schedule.weeks[weekIndex].days[currentDayIndex].slots.sort((a, b) => a.time.localeCompare(b.time));
      
      saveSchedule();
      renderSchedule();
      closeModal();
    });

    function deleteSlot(weekId, dayIndex, slotId) {
      const week = schedule.weeks.find(w => w.id === weekId);
      if (week) {
        week.days[dayIndex].slots = week.days[dayIndex].slots.filter(s => s.id !== slotId);
        saveSchedule();
        renderSchedule();
      }
    }

    function renderSchedule() {
      const grid = document.getElementById('scheduleGrid');
      grid.innerHTML = '';

      schedule.weeks.forEach(week => {
        week.days.forEach((day, dayIndex) => {
          const dayCard = document.createElement('div');
          dayCard.className = 'day-card';
          
          dayCard.innerHTML = `
            <h3>${day.name}</h3>
            ${day.slots.map(slot => `
              <div class="time-slot ${slot.clientName ? 'booked' : ''}">
                <strong>${slot.time}</strong>
                ${slot.clientName ? `
                  <div class="client-info">
                    <div>${slot.clientName}</div>
                    <div>${slot.clientPhone}</div>
                    ${slot.notes ? `<div>${slot.notes}</div>` : ''}
                  </div>
                ` : ''}
                <button class="btn btn-secondary" style="margin-top:8px" 
                  onclick="deleteSlot(${week.id}, ${dayIndex}, ${slot.id})">
                  Удалить
                </button>
              </div>
            `).join('')}
            <button class="add-slot" onclick="addSlot(${week.id}, ${dayIndex})">
              + Добавить время
            </button>
          `;
          
          grid.appendChild(dayCard);
        });
      });
    }

    // Обработчики событий
    document.getElementById('addWeekBtn').addEventListener('click', addWeek);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      sessionStorage.removeItem('authUser');
      window.location.href = 'admin-login.html';
    });

    // Инициализация
    checkAuth();
    renderSchedule();
  </script>
</body>
</html>